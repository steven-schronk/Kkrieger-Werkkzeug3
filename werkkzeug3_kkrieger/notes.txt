Werkkzeug 3 & KKrieger Project Notes -------------------------------------

.k   files open with Werkkzeug. Contains graphics.
.kx  files open with the player executable. Contains graphics and sound.
.v2m files are midi music files.

Main window for Werkkzeug is in this class:
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\appbrowser.cpp

File selector class is:
sBrowserTree

Operators - Individual instructions for creating geometry, textures, etc.
struct KOp
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\kdoc.hpp

KOp represents the internal operation that is run to create the desired effect. KOps are found both on the player side and the Werkkzeug side.
WerkOp is only found in Werkkzeug and is a wrapper around the KOp that has additional parameters for the UI like, position, size, width, etc.

Geometry is created and modified in Werkkzeug using WerkOp objects.
These are a wrapper for the actual ops known as KOps.
WerkOps stores the position in the grid, width, name, etc.

KOps can have animation ops as well. Each time an Op is executed, a search is performed for potential animation ops:
WerkOpAnim *WinPara::FindOpAnim()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winpara.cpp

Werk Op Animation object is defined here:
class WerkOpAnim
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.hpp

Animation is performed by this call:
sInt KEnvironment::ExecuteAnim(struct KOp *op,sU8 *bytecode)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\kdoc.cpp

Animation Op codes are displayed in the top left of the animation page (window):
void WinAnimPage::OnPaint()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winpara.cpp

Each 2 or 4 character set of numbers represents a single Op.
The first two characters represent the Op itself.
The last two (if present) represent a parameter for the Op to work with.
The Op codes are listed here:
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\kdoc.hpp

DirectX Overlay - A dedicated area of video memory that can be overlayed on the primary surface
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\genoverlay.cpp

Windows Parameters - Sliders to change numerical values in Werkkzeug
class WinPara
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winpara.cpp

Virtual Machine - Stack & stack operations, execution code.
class sScriptVM
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\script.hpp

Bytecode For Virtual Machine
enum KBytecode2
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\script.hpp

Any time an Op in the editor is clicked this function is called:
void WinPara::SetOpNow(WerkOp *op)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winpara.cpp

Operators have three marks on the left side of their box in the UI:
Red   - Top Operator is selected
Black - Middle - Has been compiled in the past or has been selected in this session?
Green - Bottom Operator is compiled and running OK

When an operator's background turns red it indicates that something is wrong with the operator.
This happens when the operator above it is not compatible.

Some operators have a filmstrip on the right side that moves downward.
This indicates that this operator causes some form of animation.

Some operators do not have either an input or an output. If the input is not available, the top of the box will be clipped at an angle. If output from the operator is not available, the bottom of the box will be clipped at an angle.

When the user clicks on a Cube operator this is called:
void Edit_Mesh_Cube(WerkkzeugApp *app,WerkOp *op)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkops.cpp

Each time a parameter for a cube us adjusted this is called:
GenMesh * __stdcall Mesh_Cube(sInt tx,sInt ty,sInt tz,sInt flags,sFSRT srt)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\genmesh.cpp

Called each time the window is painted:
void sGuiManager::OnPaint()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_gui.cpp

Paints (renders) the 3D window pane:
void WinView::OnPaint3d(sViewport &viewPort)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winview.cpp

Central point for handling different types of window actions:
sBool sAppHandler(sInt code,sDInt value)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug3\wz3_main.cpp

Glues everything together: logic, events, operators, splines, memory, time, camera
class KEnvironment;
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\kdoc.hpp

Drawing specific Ops in UI is handled by this class:
class WinView
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winview.cpp

Display texture bitmap in the UI:
void WinView::ShowBitmap(sViewport &view,class GenBitmap *tex)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winview.cpp

Displaying a mesh such as a cylindar, sphere, etc in the UI:
void WinView::ShowMesh(sViewport &view,GenMesh *mesh,KEnvironment *kenv)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winview.cpp

Displaying finished materials in the UI:
void WinView::ShowMaterial(sViewport &view,WerkOp *op,KEnvironment *kenv)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\winview.cpp

System configuration is stored in this global variable:
struct sSystem_
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.hpp

Logging - System has custom logging methods:
void __cdecl sDPrintF(const sChar *format,...)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_types.cpp

Application starts here.
int APIENTRY WinMain(HINSTANCE inst,HINSTANCE prev,LPSTR cmdline,int show)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

All opcodes used by a demo.
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\player_demo\demo_oplist.cpp
Note: These opcodes are listed in Hex but stored as a integer in the KOp and WerkOp classes.

Configuration file for Werkkzeug is loaded here:
sBool WerkkzeugApp::LoadConfig()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

Werkkzeug config file is located in the same folder as the .exe with file name werkkzeug.config.
The datatype for the file is sU32, so each entry is 32 bits.
It starts with this magic number: 0x3c3c3c3c
CID data is stored next.
Followed by version number and then size.
And ends with this magic number:  0x3e3e3e3e

Configuration settings for the tool get set here:
sBool WerkkzeugApp::LoadConfig()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

File for demo is opened here in player_intro:
sU8 *sSystem_::LoadFile(const sChar *name,sInt &size)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp
All data contained in file is cast to a sU8 datatype before writing to disk.

File for demo is opened here in werkkzeug3:
sU8 *sDiskItem::Load()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_diskitem.cpp

File is made of an array of this type:
typedef unsigned char sU8; /* 8 bits */

When a new project file is loaded the WerkkzeugApp class has to be cleared:
void WerkkzeugApp::Clear()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

The binary data from the (previously read) project file is loaded into the WerkDoc here:
sBool WerkDoc::Read(sU32 *&data)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

After all the WerkOps are setup they have to be connected together to form a tree:
void WerkDoc::Connect()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

Music for the project gets loaded here:
void WerkkzeugApp::MusicLoad()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

".k" file for demo is saved here:
sBool WerkkzeugApp::Write(sU32 *&data)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\werkkzeug.cpp

Opens up dialog box that asks for resolution, vsync, fullscreen, etc
sBool ConfigDialog(sInt nr,const sChar *title)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

DirectX libraries are loaded here:
void sSystem_::InitX()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Initialize Direct Sound:
sBool sSystem_::InitDS()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Virtual machine written in assembly language for sound generation:
Originally written for NASM assembler.
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_viruz2a.asm

Debug build uses nasm.exe which is a 16bit DOS executable.
Release build uses nasmw.exe which is a 32bit Windows console executable.
NASM uses a variant of Intel assembly syntax instead of AT&T syntax.

Start DemoScene - Main Loop
DXDev->BeginScene()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Start DirectX Screens
void sSystem_::InitScreens()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Create Buffers For Geometry (Vertices)
One is a Vertex Buffer The Other Is An Index Buffer
void sSystem_::CreateGeoBuffer(sInt i,sInt dyn,sInt index,sInt size)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Geometry is loaded into the video card here:
sInt sSystem_::GeoAdd(sInt fvf,sInt prim)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Size of buffers is hard set to large number.
#define MAX_DYNVBSIZE (64*0x8000)   /*    65,535 */
#define MAX_DYNIBSIZE (3*2*0x40000) /* 1,572,864 */

Starting DirectSound - Sample Format - starts thread for sound
sBool sSystem_::InitDS()
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

Load Textures Into DirectX
sInt sSystem_::AddTexture(sInt xs,sInt ys,sInt format,sU16 *data,sInt mipcount,sInt miptresh)
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp

-------

player_intro will open up and play a file only if you turn on compatibility with Windows 98.
Only seems to work with debris_chaos.kx and intro.kx files.

player_intro.exe C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\data\debris_chaos.kx
player_intro.exe C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\data\intro.kx

Keep default options. Wait until the progress bar has completed, then press the spacebar.

-------

Compilation Notes:

/01 	Minimal Size
/GY[-]  Function level linking (only links in functions that are needed).

------

The build contains a forced Header file that is the System Configuration file.

C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\player_intro\intro_config.hpp

------

I noticed something unusual in the code at this location:
C:\Users\eclipse\source\repos\Kkrieger-Werkkzeug3\werkkzeug3_kkrieger\_start.cpp:1706

#pragma lekktor(on)

Everything after that is grayed out as though it is not part of the build. Couldn't figure out how the data from the .kx file makes it into player_intro.exe program.
Turns out lekktor is a misspelled German word for lektor. (Remember they add an extra 'k' to the names of things.) That word means lecturer which translates into techspeak as logger.

When you turn that off, you can debug those lines after a rebuild.

------

When reading the binary data from a project file some bit shift magic is happening:

sInt inline OPC_GETDATA(sU32 x)   {return (x&0x000000ff);}
sInt inline OPC_GETINPUT(sU32 x)  {return (x&0x00000f00)>>8;}
sInt inline OPC_GETLINK(sU32 x)   {return (x&0x0000f000)>>12;}
sInt inline OPC_GETSTRING(sU32 x) {return (x&0x00070000)>>16;}
sInt inline OPC_GETSPLINE(sU32 x) {return (x&0x00700000)>>20;}

sU32 *&data

/* get a blob of data from a file */

data += OPC_GETDATA(conv);

------

Reading sections of an sF32 (float type):

void sVector::Read(sU32 *&p)
{
  x = ((sF32 *)p)[0];  // x, y, z, w is a float
  y = ((sF32 *)p)[1];
  z = ((sF32 *)p)[2];
  w = ((sF32 *)p)[3];
  p+=4;
}

------

Double right clicking an object in the 3Dviewer shows the geometry in wireframe.